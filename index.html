<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Date Range Extension (index(2) + inline settings)</title>
  <style>
    :root {
      --w:236px; --h:200px; --gap:2px; --pad:4px; --r:8px;
      --bg:#FAFAFA; --panel:#FFFFFF; --border:#E5E7EB;
      --ink:#333333; --muted:#6B7280; --accent:#2563EB;
      --range:#E0E7FF; --disabled:#9CA3AF;
      /* lighter previous-period shades */
      --prev-range:#F5F6F8;
      --prev-accent:#E5E7EB;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { width:var(--w); height:var(--h); padding:var(--pad); box-sizing:border-box; }
    .box { position:relative; width:100%; height:100%; background:var(--panel); border:1px solid var(--border); border-radius:var(--r); padding:4px; box-sizing:border-box; display:flex; flex-direction:column; gap:2px; }
    .head { display:flex; align-items:center; justify-content:space-between; gap:4px; }
    .btn {
      all:unset; cursor:pointer; padding:0 6px; height:20px; line-height:20px;
      border-radius:6px; border:1px solid var(--border); background:#F3F4F6; color:var(--ink);
      font-size:11px; white-space:nowrap; display:flex; align-items:center; justify-content:center; text-align:center;
    }
    .btn.icon { width:22px; padding:0; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .lbl { font-size:12px; color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:120px; text-align:center; }
    .gear { all:unset; width:22px; height:20px; line-height:20px; border:1px solid var(--border); background:#F3F4F6; border-radius:6px; text-align:center; cursor:pointer; display:none; }
    .grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:var(--gap); }
    #dow { padding-top:4px; }
    .dow { font-size:10px; color:var(--muted); text-align:center; padding:2px 0; }
    .cell {
      position:relative; font-size:11px; text-align:center; line-height:18px; height:18px;
      border-radius:6px; user-select:none; border:1px solid transparent; color:var(--ink);
    }
    .cell:hover { outline:2px solid rgba(37,99,235,.2); }
    .cell.disabled { color: var(--disabled); pointer-events:none; outline:none; }
    .in-range { background: var(--range); }
    .start, .end { background: var(--accent); color:#fff; font-weight:700; }
    .start { border-top-left-radius:8px; border-bottom-left-radius:8px; }
    .end   { border-top-right-radius:8px; border-bottom-right-radius:8px; }
    /* previous period — lighter and subtle */
    .prev-range { background: var(--prev-range); }
    .prev-start, .prev-end { background: var(--prev-range); font-weight:600; }
    .prev-start { border-top-left-radius:8px; border-bottom-left-radius:8px; }
    .prev-end   { border-top-right-radius:8px; border-bottom-right-radius:8px; }
    .cell.today::after { content:''; position:absolute; inset:2px; border:1px dashed var(--accent); border-radius:5px; pointer-events:none; }
    .foot { display:flex; gap:4px; justify-content:space-between; margin-top:0px; flex-wrap:wrap; }
    .foot .btn { flex:1; font-size:10px; height:20px; line-height:20px; }

    /* Inline settings panel (overlay; visible only в режиме Edit/Authoring) */
    .panel {
      position:absolute;
      left:8px; right:8px; bottom:-12px; /* ниже на ~20px от базовой позиции */
      background:#fff; border:1px solid var(--border);
      border-radius:10px; padding:10px; box-shadow:0 6px 20px rgba(0,0,0,.08);
      display:none; z-index:10; max-height:calc(var(--h) - 16px); overflow:auto;
    }
    .panel.show { display:block; }
    .row { display:flex; gap:8px; margin-top:6px; }
    label { display:block; font-size:11px; color:#374151; margin:0 0 4px; }
    select, input[type="checkbox"], input[type="text"], input[type="number"] { box-sizing:border-box; }
    select, input[type="text"], input[type="number"] { width:100%; border:1px solid #E5E7EB; border-radius:6px; padding:4px 6px; font-size:12px; background:#fff; }
    input[type="number"] { -moz-appearance: textfield; }
    .panel .btns { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .panel .btns #saveCfg { background:#D4EEC8; border-color:#D4EEC8; } /* save button tint */
    .toggle { display:flex; align-items:center; gap:8px; font-size:12px; color:#111827; margin-top:8px; }

    /* Buttons config list */
    .btncfg { margin-top:8px; border-top:1px dashed var(--border); padding-top:8px; }
    .btncfg h4 { margin:0 0 6px; font-size:12px; color:#111827; }

    /* Config rows: wider name, narrow days; +/- 20x20 */
    .btnrow { display:grid; grid-template-columns: 1fr 40px 20px; gap:6px; align-items:center; margin-bottom:6px; }
    .btnrow input.btnLabel { width:100%; height:24px; }
    .btnrow input.btnDays  { width:40px; height:24px; padding-right:4px; padding-left:6px; }
    .btnrow .btn { height:20px; line-height:20px; font-size:14px; font-weight:700; padding:0; width:20px; min-width:20px; border-radius:6px; }
    .btnrow .del { background:#FEE2E2; border-color:#FCA5A5; }
    .btnrow .del:hover { filter:brightness(0.98); }

    /* Add row */
    .btnadd { display:grid; grid-template-columns: 1fr 40px 20px; gap:6px; align-items:center; }
    .btnadd input#newBtnLabel { width:100%; height:24px; }
    .btnadd input#newBtnDays  { width:40px; height:24px; }
    .btnadd .btn#addBtn { height:20px; width:20px; min-width:20px; line-height:20px; font-size:16px; font-weight:700; padding:0; background:#ECFDF5; border-color:#A7F3D0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <div class="head">
        <button class="btn icon" id="prev">‹</button>
        <div class="lbl" id="monthLabel"></div>
        <button class="btn icon" id="next">›</button>
        <button class="gear" id="cfg" title="Настройки">⚙︎</button>
      </div>
      <div class="grid" id="dow"></div>
      <div class="grid" id="grid"></div>
      <div class="foot" id="footBtns"></div>

      <!-- Встроенная панель настроек поверх календаря -->
      <div class="panel" id="settingsPanel" aria-hidden="true">
        <div class="row" style="margin-top:0">
          <div style="flex:1">
            <label for="startParamName">Start param</label>
            <select id="startParamName"></select>
          </div>
          <div style="flex:1">
            <label for="endParamName">End param</label>
            <select id="endParamName"></select>
          </div>
        </div>
        <div class="row">
          <div style="flex:1">
            <label for="rangeParamName">Range param</label>
            <select id="rangeParamName"></select>
          </div>
        </div>
        <div class="toggle">
          <input type="checkbox" id="showPrevPeriod" />
          <label for="showPrevPeriod" style="margin:0;">Предыдущий период</label>
        </div>

        <!-- Пресеты -->
        <div class="btncfg">
          <h4>Пресеты (последние N дней)</h4>
          <div id="btnList"></div>
          <div class="btnadd">
            <input type="text" id="newBtnLabel" placeholder="Название кнопки (например, Последние 7 дней)" />
            <input type="number" id="newBtnDays" min="1" value="7" />
            <button class="btn add" id="addBtn" aria-label="Добавить">+</button>
          </div>
        </div>

        <div class="btns">
          <button class="btn" id="cancelCfg">Отмена</button>
          <button class="btn" id="saveCfg">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- loader ---
    const loadScript = (src) => new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=()=>res(src); s.onerror=()=>rej(new Error('Fail '+src)); document.head.appendChild(s); });
    async function ensureAPI(){
      try{ await loadScript('./tableau.extensions.1.latest.js'); if (window.tableau && tableau.extensions) return; }catch(_){}
      try{ await loadScript('https://tableau.github.io/extensions-api/lib/tableau.extensions.1.latest.js'); }catch(_){}
    }

    // --- defaults ---
    const DEFAULTS = {
      startParamName: 'StartDate',
      endParamName:   'EndDate',
      sheetName:      'dt_sheet',
      fieldName:      'dt',
      rangeParamName: 'MinMaxDate',
      settingsParamName: '',
      showPrevPeriod: false,
      disableMonthNavOutside: true, // ignored now (nav always allowed)
      initialPreset:  'params', // 'params' | 'today' | 'last30'
      locale:         'ru-RU',
      monthLabelCase: 'capitalize', // or 'none'
      styles: {
        pageBg:  '#FAFAFA',
        panelBg: '#FFFFFF',
        text:    '#333333',
        accent:  '#2563EB',
        border:  '#E5E7EB'
      },
      buttonsMarginTopPx: 0,
      quickButtons: [
        { label: 'Сегодня', days: 1 },
        { label: 'Последние 30 дней', days: 30 }
      ]
    };

    // --- cached DOM refs ---
    const DOW = document.getElementById('dow');
    const GRID = document.getElementById('grid');
    const FOOT = document.getElementById('footBtns');
    const MONTH = document.getElementById('monthLabel');
    const BTN_PREV = document.getElementById('prev');
    const BTN_NEXT = document.getElementById('next');
    const BTN_CFG  = document.getElementById('cfg');

    // --- helpers ---
    const $ = (q)=>document.querySelector(q);
    function clipNoon(d){ if (!d) return d; return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12,0,0,0); }
    function applyTheme(cfg){
      document.documentElement.style.setProperty('--bg', cfg.styles.pageBg);
      document.documentElement.style.setProperty('--panel', cfg.styles.panelBg);
      document.documentElement.style.setProperty('--ink', cfg.styles.text);
      document.documentElement.style.setProperty('--accent', cfg.styles.accent);
      document.documentElement.style.setProperty('--border', cfg.styles.border);
      FOOT.style.marginTop = (cfg.buttonsMarginTopPx||0) + 'px';
    }
    function getSettings(){
      try{
        const raw = tableau.extensions.settings.get('cfg');
        if (!raw) return {...DEFAULTS};
        const j = JSON.parse(raw);
        const merged = {...DEFAULTS, ...j, styles: {...DEFAULTS.styles, ...(j.styles||{})}};
        if (!Array.isArray(merged.quickButtons)){
          merged.quickButtons = [...DEFAULTS.quickButtons];
        }
        merged.quickButtons = merged.quickButtons
          .map(b => ({label: String(b.label||'').trim() || 'Кнопка', days: Math.max(1, parseInt(b.days||1, 10)||1)}));
        return merged;
      }catch{ return {...DEFAULTS}; }
    }
    function setSettings(cfg){
      try{
        tableau.extensions.settings.set('cfg', JSON.stringify(cfg));
        return tableau.extensions.settings.saveAsync();
      }catch{ return Promise.resolve(); }
    }

    // --- core state ---
    let CFG = {...DEFAULTS};
    let startParam=null, endParam=null;
    let startDate=null, endDate=null;
    let allowMin=null, allowMax=null, allowMinTs=null, allowMaxTs=null;
    let viewYear, viewMonth;

    function setAllowedRange(lo, hi){
      allowMin = lo ? clipNoon(lo) : null;
      allowMax = hi ? clipNoon(hi) : null;
      allowMinTs = allowMin ? +allowMin : null;
      allowMaxTs = allowMax ? +allowMax : null;
    }
    function inAllowed(d){ const t=+(d instanceof Date ? clipNoon(d) : new Date(d)); if (allowMinTs!=null && t<allowMinTs) return false; if (allowMaxTs!=null && t>allowMaxTs) return false; return true; }
    function clampToAllowed(d){ if (!d) return d; const t=+(d instanceof Date ? clipNoon(d) : new Date(d)); if (allowMinTs!=null && t<allowMinTs) return new Date(allowMinTs); if (allowMaxTs!=null && t>allowMaxTs) return new Date(allowMaxTs); return new Date(t); }

    function buildDOW(){
      const days=['Пн','Вт','Ср','Чт','Пт','Сб','Вс'];
      DOW.innerHTML='';
      const frag=document.createDocumentFragment();
      for(const x of days){ const e=document.createElement('div'); e.className='dow'; e.textContent=x; frag.appendChild(e); }
      DOW.appendChild(frag);
    }

    function renderFooterButtons(){
      FOOT.innerHTML='';
      const frag=document.createDocumentFragment();
      (CFG.quickButtons||[]).forEach((b, idx)=>{
        const btn = document.createElement('button');
        btn.className='btn';
        btn.textContent = b.label;
        btn.dataset.days = String(Math.max(1, parseInt(b.days||1,10)||1));
        btn.dataset.idx = String(idx);
        frag.appendChild(btn);
      });
      FOOT.appendChild(frag);
    }

    function render(){
      const d1 = new Date(viewYear, viewMonth, 1);
      let label = d1.toLocaleString(CFG.locale, {month:'long', year:'numeric'});
      if (CFG.monthLabelCase==='capitalize') label = label.charAt(0).toUpperCase()+label.slice(1);
      MONTH.textContent = label;

      GRID.innerHTML='';
      const frag=document.createDocumentFragment();
      const dow = d1.getDay() || 7;
      const offset = dow - 1;
      for(let i=0;i<offset;i++){ const x=document.createElement('div'); x.className='cell'; x.style.visibility='hidden'; frag.appendChild(x); }

      const days = new Date(viewYear, viewMonth+1, 0).getDate();
      const today = clipNoon(new Date()); const todayTs=+today;

      // prev period boundaries (if enabled)
      let prevStart=null, prevEnd=null, prevStartTs=null, prevEndTs=null;
      if (CFG.showPrevPeriod && startDate && endDate){
        const diffDays = Math.round((+endDate - +startDate) / 86400000);
        prevEnd = clipNoon(new Date(startDate)); prevEnd.setDate(prevEnd.getDate() - 1); prevEndTs=+prevEnd;
        prevStart = clipNoon(new Date(startDate)); prevStart.setDate(prevStart.getDate() - diffDays - 1); prevStartTs=+prevStart;
      }

      for(let d=1; d<=days; d++){
        const dt=clipNoon(new Date(viewYear, viewMonth, d)); const ts=+dt;
        const el=document.createElement('div'); el.className='cell'; el.textContent=d; el.dataset.ts=String(ts);
        const disabled = !inAllowed(ts);
        if (disabled) { el.classList.add('disabled'); el.setAttribute('aria-disabled','true'); }
        if (ts===todayTs) el.classList.add('today');

        // current selection
        if (!disabled){
          if (startDate && endDate){
            const a=+startDate, b=+endDate;
            if (ts>a && ts<b) el.classList.add('in-range');
            if (ts===a) el.classList.add('start');
            if (ts===b) el.classList.add('end');
          } else if (startDate && ts===+startDate) el.classList.add('start');
        }

        // previous period shading (subtle gray)
        if (!disabled && prevStart && prevEnd){
          if (ts>prevStartTs && ts<prevEndTs) el.classList.add('prev-range');
          if (ts===prevStartTs) el.classList.add('prev-start');
          if (ts===prevEndTs) el.classList.add('prev-end');
        }
        frag.appendChild(el);
      }
      GRID.appendChild(frag);

      // arrows always enabled
      BTN_PREV.disabled = false; BTN_NEXT.disabled = false;

      renderFooterButtons();
    }

    function normalize(){ if (startDate && endDate && startDate > endDate) [startDate, endDate] = [endDate, startDate]; }

    async function writeParams(){
      if (!startParam || !endParam) return;
      try{
        // write both at once (only after full range is chosen)
        await Promise.all([
          startParam.changeValueAsync(new Date(startDate)),
          endParam.changeValueAsync(new Date(endDate))
        ]);
      }catch(_){}
    }

    // On day pick: only update parameters AFTER second click
    function onPick(date, disabled){
      if (disabled || !inAllowed(date)) return;
      if (!startDate || (startDate && endDate)) {
        // start new selection, do NOT write params yet
        startDate=clipNoon(date); endDate=null;
      } else {
        endDate=clipNoon(date); normalize();
        // write both params only once full range selected
        writeParams();
      }
      render();
    }

    async function getRangeFromWorksheet(sheetName, fieldName){
      try{
        const dashboard = tableau.extensions.dashboardContent.dashboard;
        const sheet = dashboard.worksheets.find(w => w.name === sheetName);
        if (!sheet) return [null, null];
        const data = await sheet.getSummaryDataAsync({ignoreSelection: true});
        const idx = data.columns.findIndex(c => c.fieldName === fieldName || c.alias === fieldName);
        if (idx === -1) return [null, null];
        let min=null, max=null;
        for (const row of data.data){
          const v = row[idx].value;
          if (!v) continue;
          const raw = (v instanceof Date) ? v : new Date(v);
          const d = clipNoon(raw);
          if (isNaN(+d)) continue;
          if (!min || d < min) min = d;
          if (!max || d > max) max = d;
        }
        return [min, max];
      } catch(e){ return [null, null]; }
    }

    function toggleSettings(show){
      const p=$('#settingsPanel'); if (!p) return;
      p.classList.toggle('show', !!show);
      p.setAttribute('aria-hidden', show?'false':'true');
    }
    function makeBtnRow(label, days){
      const row = document.createElement('div');
      row.className='btnrow';
      const i1 = document.createElement('input'); i1.type='text'; i1.className='btnLabel'; i1.value = label || ''; i1.placeholder='Название';
      const i2 = document.createElement('input'); i2.type='number'; i2.className='btnDays'; i2.min='1'; i2.value = String(Math.max(1, parseInt(days||1,10)||1));
      const del = document.createElement('button'); del.className='btn del'; del.textContent='−'; del.setAttribute('aria-label','Удалить');
      del.addEventListener('click', ()=> row.remove());
      row.appendChild(i1); row.appendChild(i2); row.appendChild(del);
      return row;
    }
    function loadButtonsToUI(){
      const list = document.getElementById('btnList');
      list.innerHTML='';
      (CFG.quickButtons||[]).forEach(b=>{
        list.appendChild(makeBtnRow(b.label, b.days));
      });
    }

    async function openInlineSettings(){
      try{
        const isAuthoring = tableau.extensions?.environment?.mode === tableau.ExtensionMode.Authoring;
        if (!isAuthoring) return;
        const dash = tableau.extensions.dashboardContent.dashboard;
        const params = await dash.getParametersAsync();
        const names = params.map(p=>p.name);

        const s=$('#startParamName'), e=$('#endParamName'), r=$('#rangeParamName');
        s.innerHTML=''; e.innerHTML=''; r.innerHTML='';
        for (const n of names){
          const o1=document.createElement('option'); o1.value=o1.textContent=n; s.appendChild(o1);
          const o2=document.createElement('option'); o2.value=o2.textContent=n; e.appendChild(o2);
          const o3=document.createElement('option'); o3.value=o3.textContent=n; r.appendChild(o3);
        }
        if (names.includes(CFG.startParamName)) s.value=CFG.startParamName;
        if (names.includes(CFG.endParamName))   e.value=CFG.endParamName;
        if (names.includes(CFG.rangeParamName)) r.value=CFG.rangeParamName;
        else if (names.includes('MinMaxDate'))  r.value='MinMaxDate';

        // toggle previous period
        const chk = document.getElementById('showPrevPeriod');
        if (chk) chk.checked = !!CFG.showPrevPeriod;

        // buttons
        loadButtonsToUI();

        // add handler
        const addBtn = document.getElementById('addBtn');
        const newLabel = document.getElementById('newBtnLabel');
        const newDays  = document.getElementById('newBtnDays');
        addBtn.onclick = ()=>{
          const label = (newLabel.value||'').trim() || 'Кнопка';
          const days = Math.max(1, parseInt(newDays.value||'1',10)||1);
          document.getElementById('btnList').appendChild(makeBtnRow(label, days));
          newLabel.value=''; newDays.value='7';
        };
      }catch(e){ console.warn('Не удалось получить параметры', e); }
      toggleSettings(true);
    }

    async function initInsideTableau(){
      CFG = getSettings();
      applyTheme(CFG);

      try{
        const isAuthoring = tableau.extensions?.environment?.mode === tableau.ExtensionMode.Authoring;
        if (isAuthoring) BTN_CFG.style.display = 'inline-block';
      }catch(_){}

      const params = await tableau.extensions.dashboardContent.dashboard.getParametersAsync();
      startParam = params.find(p => p.name===CFG.startParamName);
      endParam   = params.find(p => p.name===CFG.endParamName);

      // allowed range from param or worksheet
      const [pLo, pHi] = await getRangeFromParam(CFG.rangeParamName || 'MinMaxDate');
      if (pLo && pHi){ setAllowedRange(pLo, pHi); }
      else {
        const [wLo, wHi] = await getRangeFromWorksheet(CFG.sheetName, CFG.fieldName);
        setAllowedRange(wLo, wHi);
      }

      // initial values
      if (CFG.initialPreset === 'today'){
        const now = clipNoon(new Date()); startDate = clampToAllowed(now); endDate = clampToAllowed(now);
      } else if (CFG.initialPreset === 'last30'){
        const now = clipNoon(new Date()); startDate = clampToAllowed(new Date(now.getFullYear(), now.getMonth(), now.getDate() - 29, 12)); endDate = clampToAllowed(now);
      } else {
        const minV = startParam?.currentValue?.value ? clipNoon(new Date(startParam.currentValue.value)) : null;
        const maxV = endParam?.currentValue?.value ? clipNoon(new Date(endParam.currentValue.value)) : null;
        startDate = clampToAllowed(minV);
        endDate   = clampToAllowed(maxV);
      }
      if (!(startDate||endDate)){ const now=new Date(); startDate=clipNoon(now); endDate=clipNoon(now); }
      if (startDate && endDate && startDate > endDate) [startDate, endDate] = [endDate, startDate];

      const base = endDate || startDate || (allowMin || clipNoon(new Date()));
      viewYear=base.getFullYear(); viewMonth=base.getMonth();

      BTN_CFG.addEventListener('click', openInlineSettings);
      document.getElementById('cancelCfg').addEventListener('click', ()=> toggleSettings(false));
      document.getElementById('saveCfg').addEventListener('click', async ()=>{
        const sEl=$('#startParamName'), eEl=$('#endParamName'), rEl=$('#rangeParamName');
        const chk = document.getElementById('showPrevPeriod');

        // collect buttons
        const rows = Array.from(document.querySelectorAll('#btnList .btnrow'));
        const qb = rows.map(r=>{
          const label = (r.querySelector('.btnLabel')?.value || '').trim() || 'Кнопка';
          const days  = Math.max(1, parseInt(r.querySelector('.btnDays')?.value || '1',10)||1);
          return { label, days };
        });

        CFG.startParamName = sEl?.value || CFG.startParamName;
        CFG.endParamName   = eEl?.value || CFG.endParamName;
        CFG.rangeParamName = rEl?.value || CFG.rangeParamName;
        CFG.showPrevPeriod = !!(chk && chk.checked);
        CFG.quickButtons   = qb.length ? qb : [...DEFAULTS.quickButtons];

        await setSettings(CFG);
        try{
          const params2 = await tableau.extensions.dashboardContent.dashboard.getParametersAsync();
          startParam = params2.find(p => p.name===CFG.startParamName);
          endParam   = params2.find(p => p.name===CFG.endParamName);
          const [lo, hi] = await getRangeFromParam(CFG.rangeParamName || 'MinMaxDate');
          if (lo && hi) setAllowedRange(lo, hi);
          // clamp current selection to new bounds
          startDate = clampToAllowed(startDate);
          endDate   = clampToAllowed(endDate);
        }catch{}
        render();
        toggleSettings(false);
      });

      tableau.extensions.settings.addEventListener(tableau.TableauEventType.SettingsChanged, ()=>{
        CFG = getSettings(); applyTheme(CFG); render();
      });

      buildDOW(); render();
    }

    async function boot(){
      await ensureAPI();
      if (!(window.tableau && tableau.extensions)){
        BTN_CFG.addEventListener('click', ()=>alert('Откройте в Tableau, чтобы настраивать расширение.'));
        const now=new Date(); viewYear=now.getFullYear(); viewMonth=now.getMonth(); buildDOW(); render(); return;
      }
      try{
        await tableau.extensions.initializeAsync();
        await initInsideTableau();
      }catch(e){ console.error(e);
        const now=new Date(); viewYear=now.getFullYear(); viewMonth=now.getMonth(); buildDOW(); render();
      }
    }

    // --- event delegation (optimization) ---
    document.addEventListener('click', async (e)=>{
      if (e.target.id==='prev'){
        const y = viewYear + (viewMonth===0 ? -1 : 0);
        const m = viewMonth===0 ? 11 : (viewMonth-1);
        viewYear=y; viewMonth=m; render();
        return;
      }
      if (e.target.id==='next'){
        const y = viewYear + (viewMonth===11 ? 1 : 0);
        const m = viewMonth===11 ? 0 : (viewMonth+1);
        viewYear=y; viewMonth=m; render();
        return;
      }
      // calendar cell click
      const cell = e.target.closest('.cell');
      if (cell && cell.dataset.ts){
        if (!cell.classList.contains('disabled')){
          onPick(new Date(Number(cell.dataset.ts)), false);
        }
        return;
      }
      // quick buttons
      const qbtn = e.target.closest('#footBtns .btn');
      if (qbtn && qbtn.dataset.days){
        const n = Math.max(1, parseInt(qbtn.dataset.days||'1',10)||1);
        const now = clipNoon(new Date());
        const start = clipNoon(new Date(now.getFullYear(), now.getMonth(), now.getDate() - (n-1)));
        startDate = clampToAllowed(start);
        endDate   = clampToAllowed(now);
        viewYear = endDate.getFullYear(); viewMonth = endDate.getMonth();
        render();
        await writeParams(); // presets write both immediately
        return;
      }
    });

    // --- helpers for range param ---
    async function getRangeFromParam(paramName){
      try{
        const dashboard = tableau.extensions.dashboardContent.dashboard;
        const params = await dashboard.getParametersAsync();
        const p = params.find(x => x.name === paramName);
        const raw = p?.currentValue?.value;
        if (!raw || typeof raw !== 'string') return [null, null];
        const [loStr, hiStr] = raw.split('|').map(s => (s||'').trim());
        const lo = new Date(loStr), hi = new Date(hiStr);
        if (isNaN(+lo) || isNaN(+hi)) return [null, null];
        lo.setHours(12,0,0,0); hi.setHours(12,0,0,0);
        return [lo, hi];
      } catch(e){ console.warn('getRangeFromParam failed', e); return [null, null]; }
    }

    boot();
  </script>
</body>
</html>
