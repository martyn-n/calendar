
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DateRange Calendar Widget</title>
  <style>
    :root {
      --w: 260px;
      --h: 165px; /* fixed settings panel height as requested */
      --pad: 8px;
      --gap: 6px;
      --r: 10px;
      --font: 12px;
    }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap {
      width: var(--w);
      height: var(--h);
      padding: var(--pad);
      box-sizing: border-box;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      background: #0b0c10;
      color: #e6e6e6;
      border-radius: var(--r);
    }
    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 6px;
      align-items: center;
    }
    .title { font-size: 13px; font-weight: 600; opacity: .95; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    button.nav {
      border: 1px solid #2e3440;
      background: #15171c;
      color: #e6e6e6;
      border-radius: 8px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    button.nav:disabled {
      opacity: .35;
      cursor: not-allowed;
    }
    .cal {
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 6px;
      overflow: hidden;
      min-height: 0;
    }
    .dow {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      font-size: 11px;
      color: #aab0b7;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: 22px;
      gap: 2px;
      overflow: auto;
      padding-right: 2px;
    }
    .cell {
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: var(--font);
      background: #121419;
      color: #d8dee9;
      user-select: none;
    }
    .cell.muted { color: #6b7280; opacity: .6; }
    .cell.inrange { outline: 1px solid #3b82f6; }
    .cell.clickable { cursor: pointer; }
    .cell.clickable:hover { background: #1a1d25; }
    .cell.disabled {
      pointer-events: none;
      opacity: .35;
      filter: grayscale(.6);
    }
    .legend {
      font-size: 10px; color:#9aa2ac; opacity:.9;
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .legend .pill {
      display:inline-flex; align-items:center; gap:4px;
    }
    .dot { width:10px; height:10px; border-radius:999px; background:#3b82f6; display:inline-block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="title" id="title"></div>
      <button class="nav" id="prev" title="Предыдущий месяц">‹</button>
      <button class="nav" id="next" title="Следующий месяц">›</button>
    </div>
    <div class="cal">
      <div class="dow">
        <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="legend">
        <span class="pill"><span class="dot"></span> кликабельно (внутри диапазона)</span>
        <span>Источник: параметр <code>DateRangeExtCfg</code></span>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ===== Utilities =====
    const monthsRu = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const clipNoon = (d) => { const x=new Date(d); x.setHours(12,0,0,0); return x; };
    const ymd = (d) => d.toISOString().slice(0,10);

    // Strict parser for "YYYY-MM-DD | YYYY-MM-DD"
    function parseStrictRange(raw){
      if (typeof raw !== 'string') return [null, null];
      const m = raw.match(/^\s*(\d{4}-\d{2}-\d{2})\s*\|\s*(\d{4}-\d{2}-\d{2})\s*$/);
      if (!m) return [null, null];
      const lo = new Date(m[1]), hi = new Date(m[2]);
      if (isNaN(+lo) || isNaN(+hi)) return [null, null];
      return [clipNoon(lo), clipNoon(hi)];
    }

    // Querystring fallback for local testing: ?DateRangeExtCfg=2025-09-12|2025-09-22
    function readRangeFromURL(){
      const p = new URLSearchParams(location.search);
      const raw = p.get('DateRangeExtCfg');
      if (!raw) return [null, null];
      // allow both "a|b" and "a | b" in URL
      const normalized = raw.replace(/\s*\|\s*/, ' | ');
      return parseStrictRange(normalized);
    }

    // Attempt to read from Tableau Parameter "DateRangeExtCfg"
    async function readRangeFromTableau(){
      try {
        if (!window.tableau || !tableau.extensions || !tableau.extensions.dashboardContent) {
          return [null, null];
        }
        const dashboard = tableau.extensions.dashboardContent.dashboard;
        const params = await dashboard.getParametersAsync();
        const p = params.find(x => x.name === 'DateRangeExtCfg');
        const raw = p?.currentValue?.value;
        return parseStrictRange(raw);
      } catch(e){
        console.warn("Tableau read failed", e);
        return [null, null];
      }
    }

    // State
    let allowMin = null;
    let allowMax = null;
    const titleEl = document.getElementById('title');
    const gridEl  = document.getElementById('grid');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');

    // View month/year (start at allowMin or today)
    let today = clipNoon(new Date());
    let viewYear = today.getFullYear();
    let viewMonth = today.getMonth();

    function inAllowed(d){
      if (!allowMin || !allowMax) return false;
      const x = +clipNoon(d);
      return x >= +allowMin && x <= +allowMax;
    }

    function monthHasOverlap(y, m){
      if (!allowMin || !allowMax) return false;
      const start = clipNoon(new Date(y, m, 1));
      const end = clipNoon(new Date(y, m+1, 0));
      return !(end < allowMin || start > allowMax);
    }

    function render(){
      titleEl.textContent = monthsRu[viewMonth] + " " + viewYear;
      gridEl.innerHTML = "";

      // Compute first day cell (Mon-first calendar)
      const firstOfMonth = new Date(viewYear, viewMonth, 1);
      const firstWeekday = (firstOfMonth.getDay() + 6) % 7; // 0=Mon ... 6=Sun
      const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
      const prevMonthDays = new Date(viewYear, viewMonth, 0).getDate();

      // Fill leading muted days
      for (let i=0; i<firstWeekday; i++){
        const day = prevMonthDays - firstWeekday + 1 + i;
        const d = new Date(viewYear, viewMonth-1, day);
        const el = document.createElement('div');
        el.className = 'cell muted disabled';
        el.textContent = day;
        gridEl.appendChild(el);
      }
      // Fill current month
      for (let day=1; day<=daysInMonth; day++){
        const d = new Date(viewYear, viewMonth, day);
        const el = document.createElement('div');
        el.className = 'cell';

        const inside = inAllowed(d);
        if (inside) {
          el.classList.add('inrange', 'clickable');
          el.addEventListener('click', () => {
            // Example click handler — replace with your selection logic
            console.log("Click:", ymd(d));
          });
        } else {
          el.classList.add('disabled');
        }
        el.textContent = day;
        gridEl.appendChild(el);
      }
      // Trailing muted to complete weeks (up to 42 cells typical)
      const total = firstWeekday + daysInMonth;
      const trailing = (7 - (total % 7)) % 7;
      for (let i=1; i<=trailing; i++){
        const d = new Date(viewYear, viewMonth+1, i);
        const el = document.createElement('div');
        el.className = 'cell muted disabled';
        el.textContent = i;
        gridEl.appendChild(el);
      }

      // Disable prev/next if target month has no overlap with allowed range
      const prevY = viewYear + (viewMonth===0 ? -1 : 0);
      const prevM = viewMonth===0 ? 11 : (viewMonth-1);
      const nextY = viewYear + (viewMonth===11 ? 1 : 0);
      const nextM = viewMonth===11 ? 0 : (viewMonth+1);
      prevBtn.disabled = !monthHasOverlap(prevY, prevM);
      nextBtn.disabled = !monthHasOverlap(nextY, nextM);
    }

    function goPrev(){ if (!prevBtn.disabled){ if (viewMonth===0){ viewMonth=11; viewYear--; } else viewMonth--; render(); } }
    function goNext(){ if (!nextBtn.disabled){ if (viewMonth===11){ viewMonth=0; viewYear++; } else viewMonth++; render(); } }

    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);

    async function init(){
      // Try Tableau first
      let [lo, hi] = await readRangeFromTableau();
      if (!lo || !hi){
        // Fallback to URL param (for local testing)
        [lo, hi] = readRangeFromURL();
      }
      // If still nothing — leave empty (no clickable dates)
      allowMin = lo; allowMax = hi;

      // Start view at allowMin if exists
      if (allowMin){
        viewYear = allowMin.getFullYear();
        viewMonth = allowMin.getMonth();
      }

      render();
    }

    // If Tableau Extensions are available, wait for init; else run immediately
    if (window.tableau && tableau.extensions && tableau.extensions.initializeAsync){
      tableau.extensions.initializeAsync().then(init, init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
